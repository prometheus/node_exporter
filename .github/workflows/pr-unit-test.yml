name: PR test (build + docker run)

on:
  pull_request:

jobs:
  smoke:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: "1.24.x"
          cache: true

      - name: Build
        run: make build
    
      - name: Move Binary
        run: |
            mkdir -p .build/linux-amd64
            cp -f ./node_exporter .build/linux-amd64/node_exporter

      - name: Docker build
        run: docker build -t node-exporter-pr:${{ github.sha }} .

      - name: Docker run + quick scrape
        run: |
          set -e
          docker run -d --rm --name ne -p 19100:9100 node-exporter-pr:${{ github.sha }}
          for i in $(seq 1 20); do
            if curl -fsS http://127.0.0.1:19100/metrics >/dev/null; then
              echo "metrics reachable"
              break
            fi
            sleep 1
            if [ "$i" -eq 20 ]; then
              echo "node_exporter did not start"
              docker logs ne || true
              exit 1
            fi
          done
          docker stop ne

      - name: Install Trivy (official installer)
        run: |
          set -euo pipefail
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh \
          | sudo sh -s -- -b /usr/local/bin
          trivy --version

      - name: Trivy scan
        run: |
          set -euo pipefail
          trivy image prometheus-pr:${GITHUB_SHA} \
            --scanners vuln \
            --format table \
            --no-progress \
            --exit-code 0